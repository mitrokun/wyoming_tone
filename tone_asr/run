#!/usr/bin/env bash

# Прекращаем выполнение скрипта, если любая команда завершится с ошибкой
set -e

# Абсолютный путь к директории, в которой находится сам скрипт (наш проект)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

# Путь к Python внутри нашего venv
VENV_PYTHON="$SCRIPT_DIR/.venv/bin/python3"

# Проверяем, существует ли venv
if [ ! -f "$VENV_PYTHON" ]; then
    echo "Ошибка: Виртуальное окружение не найдено в '$SCRIPT_DIR'."
    echo "Пожалуйста, выполните шаги установки."
    exit 1
fi

# Определяем родительскую директорию и имя модуля
PARENT_DIR=$(dirname "$SCRIPT_DIR")
MODULE_NAME=$(basename "$SCRIPT_DIR")

# Запускаем основную логику в сабшелле (в скобках), чтобы не менять текущую директорию пользователя
(
    echo "--- Временный переход в родительскую директорию: ${PARENT_DIR} ---"
    cd "$PARENT_DIR"

    echo "--- Запуск сервера с использованием venv (модуль: ${MODULE_NAME}) ---"
    "$VENV_PYTHON" -m "$MODULE_NAME" "$@"
)
# -------------------------

echo "--- Сервер остановлен. ---"
